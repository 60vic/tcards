<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery.min.js') }}" ></script>
<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery-ui.min.js') }}" ></script>
<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery.mask.min.js') }}" ></script>
<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/notify.min.js') }}" ></script>                            

<script type=text/javascript>
  $(function() {
    $('a#calculate').bind('click', function() {
      $.getJSON('/_add_numbers', {
        a: $('input[name="a"]').val(),
        b: $('input[name="b"]').val()
      }, function(data) {
        $("#result").text(data.result);
      });
      return false;
    });
  });
</script>

<style>
body {font-size: 13px;}	
.ficap { padding: 0px; margin: 0px; width: 150px; clear: both; vertical-align: middle; inline-block;}
.fi, .ficap {float: left;}
.ficap, .fi,.fi input {padding: 2px; margin: 0px;}
.b1,.b2,.b3 {border: 1px solid black; float: left; padding: 5px; height: 100%; }
.b1 {width: 25%;}
.b2 {width: 46%;}
.b3 {width: 25%;}
.bwrap {height: 50vh;}
input {padding: 2px; margin: 0px; border: 1px solid #1E90FF;}
</style>

<div class="bwrap">
<div class="b1">
<h1>Каточка позвонившего</h1>
<form id="form1">
<div class="ficap"><button type="reset">Очистка</button></div>
<div class="ficap">Id</div><div class="fi"><input type="text" name="rowid" readonly></div>
<div class="ficap">Телефон</div><div class="fi"><input type="tel" name="tel"></div>
<div class="ficap">Мобильный</div><div class="fi"><input type="mob" name="mob"></div>
<div class="ficap">ФИО</div><div class="fi"><input type="text" name="fio"></div>
<div class="ficap">Роль</div><div class="fi"><select name="role"></select></div>
<div class="ficap">Должность</div><div class="fi"><select name="pos"></select></div>
<div class="ficap">Организация</div><div class="fi"><input type="text" name="org"></div>
<div class="ficap">Организация_</div><div class="fi"><input type="text" name="org_"></div>
<div class="ficap">ПО</div><div class="fi"><input type="text" name="soft"></div>
</form>
<div class="ficap"><button title="Сохраняет карточку в базу" id="save2db" disabled>В базу</button><br>
<button title="Заполняет пустые поля из карточки" disabled>Из карточки</button></div><div class="fi"><br><button id="search2db">Искать</button></div>
</div>
<div class="b2">
<h1>Список найденного</h1>
<table id="slist">
<tr><th>id</th><th>tel</th><th>mob</th><th>fio</th><th>org</th></tr>
</table>
</div>
<div class="b3">
<h1>Карточка в базе</h1>
<form id="form2">
<div class="ficap">Id</div><div class="fi"><input type="text" name="rowid" readonly></div>
<div class="ficap">Телефон</div><div class="fi"><input type="tel" name="tel" readonly></div>
<div class="ficap">Мобильный</div><div class="fi"><input type="tel" name="mob" readonly></div>
<div class="ficap">ФИО</div><div class="fi"><input type="text" name="fio" readonly></div>
<div class="ficap">Роль</div><div class="fi"><select name="role" readonly></select></div>
<div class="ficap">Должность</div><div class="fi"><select name="pos" readonly></select></div>
<div class="ficap">Организация</div><div class="fi"><input type="text" name="org" readonly></div>
<div class="ficap">Организация1</div><div class="fi"><input type="text" name="org_" readonly></div>
<div class="ficap">ПО</div><div class="fi"><input type="text" name="soft" disabled></div>
</form>
<div class="ficap"><button id="carddel">Удалить</button></div><div class="fi"><br><button id="card2to1">Добавить в заявление</button></div>
</div>
</div>
</div>	
<br style="clear: both;">
<h1>Заявление позвонившего</h1>
Request<br>
<div id="asd"></div>

<script>
$.getJSON( "_get_init", function( data ) {
	$.each(data['roles'], function (k,v) {
		$('#form1 select[name="role"]').append("<option name='"+v+"'>"+v+"</option>");
		});
	$.each(data['positions'], function (k,v) {
		$('#form1 select[name="pos"]').append("<option name='"+v+"'>"+v+"</option>");
		});	
  });

function notifymy(data) {
	if (data['reply']['error']) {
		$.notify(data['error'], "error");
	}
	if (data['reply']['good']) {
		$.notify(data['reply']['good'], "success");
	}
}

//установим маску для полей ввода телефонов  
$(document).ready(function(){ 
	$('#form1 input[name="mob"]').mask('+7(000)000-00-00');
});  
$(document).ready(function(){ 
	$('#form1 input[name="tel"]').mask('+7(81100)00-00-00');
});

//сохранение
$('#save2db').bind('click', function() {
	$.post('/save2db',
	$('#form1').serialize(), 
	function (data) {
		notifymy(data);
	});
});


  

//динамически меняем маску для города и районов
$("#form1 input[name='tel']").on('input', function() {
	$('#save2db').prop('disabled',true);
	var v = $("#form1 input[name='tel']").val();
	$('#asd').text(v);
	if ( v.slice(0,7) == "+7(8112" )
	{
		$("#form1 input[name='tel']").mask('+7(8112)00-00-00');
	}
	else 
	{
		$("#form1 input[name='tel']").mask('+7(81100)0-00-00');
	}
});


//удаление карточки из базы, а также из спика результатов поиска
$('#carddel').bind('click', function() {
	$.post('/carddel', {"rowid": $('#form2 input[name="rowid"]').val()}
	);
	$.each($("#slist .drid"), function () {
		if ( $(this).text() == $('#form2 input[name="rowid"]').val() ) {
			$(this).parent().remove();	
		} 
	});
});


//перенос из формы 2 в 1 если поле-приемник пустое
$('#card2to1').bind('click', function() {
	$.each($("#form2 :input"),function (){
		if ( $(`#form1 input[name='${this.name}']`).val() === "" ) {
			$(`#form1 input[name='${this.name}']`).val(this.value);
		}
	});
});

//поиск
$('#search2db').bind('click', function() {
	$('#form1 input[name="rowid"]').val("");
	$.post('/search2db',
	$('#form1').serialize(),
	function(data) {
		$('#slist .dtr').remove();
		$.each(data['result'], function (k,v) {
			$('#slist').append(`<tr class="dtr"><td class="drid">${v["rowid"]}</td><td>${v["tel"]}</td>td><td>${v["mob"]}</td>td><td>${v["fio"]}</td>td><td>${v["org"]}</td>td></li>`);
		});
		$('.drid').bind('click',function() {
			$("input[name='tel2']").val($(this).text());
			$.post('/get2rowid',{"rowid": $(this).text()}, function(data) {
				$.each(data['result'], function (k,v) {
					$.each(v, function (k,v) {
						$(`#form2 input[name='${k}']`).val(v);
					});
				});
			});
		});
	});
	$('#save2db').removeAttr('disabled');
});
	
</script>
