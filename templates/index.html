<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery.min.js') }}" ></script>
<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery-ui.min.js') }}" ></script>
<script type = "text/javascript" 
         src = "{{ url_for('static', filename = 'js/jquery.mask.min.js') }}" ></script>                  

<script type=text/javascript>
  $(function() {
    $('a#calculate').bind('click', function() {
      $.getJSON('/_add_numbers', {
        a: $('input[name="a"]').val(),
        b: $('input[name="b"]').val()
      }, function(data) {
        $("#result").text(data.result);
      });
      return false;
    });
  });
</script>

<style>
.ficap { padding: 0px; margin: 0px; width: 150px; clear: both; vertical-align: middle; inline-block;}
.fi, .ficap {float: left;}
.ficap, .fi input {padding: 5px; margin: 0px;}
.b1,.b2,.b3 {border: 1px solid black; float: left; padding: 5px; height: 100%; }
.b1 {width: 25%;}
.b2 {width: 46%;}
.b3 {width: 25%;}
.bwrap {height: 50vh;}
</style>

<div class="bwrap">
<div class="b1">
<h1>Каточка позвонившего</h1>
<form id="form1">
<div class="ficap">Телефон</div><div class="fi"><input type="tel" name="tel"></div>
<div class="ficap">Мобильный</div><div class="fi"><input type="mob" name="mob"></div>
<div class="ficap">ФИО</div><div class="fi"><input type="text" name="fio"></div>
<div class="ficap">Роль</div><div class="fi"><select name="role"></select></div>
<div class="ficap">Должность</div><div class="fi"><select name="pos"></select></div>
<div class="ficap">Организация</div><div class="fi"><input type="text" name="org"></div>
<div class="ficap">Организация_</div><div class="fi"><input type="text" name="org_"></div>
<div class="ficap">ПО</div><div class="fi"><input type="text" name="soft"></div>
</form>
<div class="ficap"><button title="Сохраняет карточку в базу" id="save2db" disabled>В базу</button><br>
<button title="Заполняет пустые поля из карточки" disabled>Из карточки</button></div><div class="fi"><br><button id="search2db">Искать</button></div>
</div>
<div class="b2">
<h1>Список найденного</h1>
<table id="slist">
<tr><th>id</th><th>tel</th><th>mob</th><th>fio</th><th>org</th></tr>
</table>
</div>
<div class="b3">
<h1>Карточка в базе</h1>
<div class="ficap">Id</div><div class="fi"><input type="text" name="rowid2" disabled></div>
<div class="ficap">Телефон</div><div class="fi"><input type="tel" name="tel2" disabled></div>
<div class="ficap">Мобильный</div><div class="fi"><input type="tel" name="mob2" disabled></div>
<div class="ficap">ФИО</div><div class="fi"><input type="text" name="fio2" disabled></div>
<div class="ficap">Роль</div><div class="fi"><select name="role2" disabled></select></div>
<div class="ficap">Должность</div><div class="fi"><select name="pos2" disabled></select></div>
<div class="ficap">Организация</div><div class="fi"><input type="text" name="org2" disabled></div>
<div class="ficap">Организация1</div><div class="fi"><input type="text" name="org_2" disabled></div>
<div class="ficap">ПО</div><div class="fi"><input type="text" name="soft2" disabled></div>
<div class="ficap"><button>Удалить</button></div><div class="fi"><br><button>Добавить в заявление</button></div>
</div>
</div>
</div>	
<br style="clear: both;">
<h1>Заявление позвонившего</h1>
Request<br>
<div id="asd"></div>

<script>
$.getJSON( "_get_init", function( data ) {
	$.each(data['roles'], function (k,v) {
		$('select[name="role"]').append("<option name='"+v+"'>"+v+"</option>");
		});
	$.each(data['positions'], function (k,v) {
		$('select[name="pos"]').append("<option name='"+v+"'>"+v+"</option>");
		});	
  });

//установим маску для полей ввода телефонов  
$(document).ready(function(){ 
	$('input[name="mob"]').mask('+7(000)000-00-00');
});  
$(document).ready(function(){ 
	$('input[name="tel"]').mask('+7(81100)00-00-00');
});

//сохранение
$('#save2db').bind('click', function() {
	$.post('/save2db',
	$('#form1').serialize(),
	function(data) {
		$("#result").text(data.result);
	});
});


  

//динамически меняем маску для города и районов
$("input[name='tel']").on('input', function() {
	$('#save2db').prop('disabled',true);
	var v = $("input[name='tel']").val();
	$('#asd').text(v);
	if ( v.slice(0,7) == "+7(8112" )
	{
		$("input[name='tel']").mask('+7(8112)00-00-00');
	}
	else 
	{
		$("input[name='tel']").mask('+7(81100)0-00-00');
	}
});

//до нажатия поиск добавление в БД неактивно
$("input[name='mob1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='fio1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='role1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='pos1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='org1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='org_1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

$("input[name='soft1']").on('input', function() {
	$('#save2db').prop('disabled',true);
	});

//поиск
$('#search2db').bind('click', function() {
	$.post('/search2db',
	$('#form1').serialize(),
	function(data) {
		$('#slist .dtr').remove();
		$.each(data['result'], function (k,v) {
			$('#slist').append(`<tr class="dtr"><td class="drid">${v["rowid"]}</td><td>${v["tel"]}</td>td><td>${v["mob"]}</td>td><td>${v["fio"]}</td>td><td>${v["org"]}</td>td></li>`);
		});
		$('.drid').bind('click',function() {
			$("input[name='tel2']").val($(this).text());
			$.post('/get2rowid',{"rowid": $(this).text()}, function(data) {
				$.each(data['result'], function (k,v) {
					$("input[name='tel2']").val(v["tel"]);
					$("input[name='mob2']").val(v["mob"]);
					$("input[name='fio2']").val(v["fio"]);
					$("input[name='org2']").val(v["org"]);
					$("input[name='org_2']").val(v["org_"]);
					$("input[name='role2']").val(v["role"]);
					$("input[name='pos2']").val(v["pos"]);
					$("input[name='soft2']").val(v["soft"]);
					$("input[name='rowid2']").val(v["rowid"]);
				});
			});
		});
	});
	$('#save2db').removeAttr('disabled');
});
	
</script>
